<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Designing a Message Queue Using MySQL · MySQL 101 - Beginner's Guide to Learning MySQL</title><meta name="description" content="Designing a Message Queue Using MySQL - onlytiancai"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://mysql101.com/atom.xml" title="MySQL 101 - Beginner's Guide to Learning MySQL"><script async src="https://www.googletagmanager.com/gtag/js?id=G-FTL5JTLX07"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-FTL5JTLX07');</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="MySQL 101 - Beginner's Guide to Learning MySQL" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Designing a Message Queue Using MySQL</h1><div class="post-info">Jan 9, 2025</div><div class="post-content"><p>Message queues are a critical component of many distributed systems, enabling asynchronous communication between different services. While dedicated tools like RabbitMQ or Kafka are often used for this purpose, you can design a lightweight message queue using MySQL for simpler use cases. This blog will demonstrate how to design such a system, ensuring that both producers and consumers can work concurrently without losing or duplicating tasks.</p>
<span id="more"></span>
<hr>
<h4 id="1-Key-Features-of-the-MySQL-Message-Queue"><a class="header-anchor" href="#1-Key-Features-of-the-MySQL-Message-Queue">¶</a>1. Key Features of the MySQL Message Queue</h4>
<ul>
<li><strong>Concurrency</strong>: Support multiple producers and consumers.</li>
<li><strong>Durability</strong>: Ensure no tasks are lost.</li>
<li><strong>Idempotency</strong>: Avoid duplicate processing of tasks.</li>
</ul>
<hr>
<h4 id="2-Table-Design"><a class="header-anchor" href="#2-Table-Design">¶</a>2. Table Design</h4>
<p>We need a single table to represent the message queue. Let’s call it <code>message_queue</code>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> message_queue (</span><br><span class="line">    message_id <span class="type">BIGINT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY, <span class="comment">-- Unique ID for each message</span></span><br><span class="line">    payload TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,                        <span class="comment">-- The actual message content</span></span><br><span class="line">    status ENUM(<span class="string">&#x27;PENDING&#x27;</span>, <span class="string">&#x27;PROCESSING&#x27;</span>, <span class="string">&#x27;DONE&#x27;</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;PENDING&#x27;</span>, <span class="comment">-- Task state</span></span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>, <span class="comment">-- Message creation timestamp</span></span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="comment">-- Last update timestamp</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="3-Key-Operations"><a class="header-anchor" href="#3-Key-Operations">¶</a>3. Key Operations</h4>
<h5 id="a-Adding-a-Task-Producer"><a class="header-anchor" href="#a-Adding-a-Task-Producer">¶</a><strong>a. Adding a Task (Producer)</strong></h5>
<p>Producers add tasks to the queue by inserting records into the <code>message_queue</code> table.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> message_queue (payload)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;&#123;&quot;task&quot;: &quot;process_file&quot;, &quot;file_id&quot;: 123&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h5 id="b-Fetching-a-Task-Consumer"><a class="header-anchor" href="#b-Fetching-a-Task-Consumer">¶</a><strong>b. Fetching a Task (Consumer)</strong></h5>
<p>Consumers fetch tasks in the <code>PENDING</code> state and mark them as <code>PROCESSING</code> to prevent other consumers from picking the same task.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>; <span class="comment">-- begin a transaction</span></span><br><span class="line"><span class="keyword">select</span> message_id <span class="keyword">into</span> <span class="variable">@message_id</span> <span class="keyword">from</span> message_queue <span class="keyword">where</span> status <span class="operator">=</span> <span class="string">&#x27;PENDING&#x27;</span> limit <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span> <span class="keyword">skip</span> locked; <span class="comment">-- pick a pending task id.</span></span><br><span class="line"><span class="keyword">update</span> message_queue <span class="keyword">set</span> status<span class="operator">=</span><span class="string">&#x27;PROCESSING&#x27;</span> <span class="keyword">where</span> message_id<span class="operator">=</span><span class="variable">@message_id</span> limit <span class="number">1</span>; <span class="comment">-- update it to processing</span></span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
<p><strong>Explanation:</strong></p>
<ul>
<li><code>FOR UPDATE SKIP LOCKED</code>: Prevents other transactions from locking the same rows, enabling concurrent consumers.</li>
<li><code>RETURNING *</code>: Returns the selected row for the consumer to process.</li>
</ul>
<h5 id="c-Completing-a-Task-Consumer"><a class="header-anchor" href="#c-Completing-a-Task-Consumer">¶</a><strong>c. Completing a Task (Consumer)</strong></h5>
<p>Once a task is successfully processed, the consumer updates its status to <code>DONE</code>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> message_queue</span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;DONE&#x27;</span>, updated_at <span class="operator">=</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line"><span class="keyword">WHERE</span> message_id <span class="operator">=</span> ?;</span><br></pre></td></tr></table></figure>
<h5 id="d-Retrying-Failed-Tasks"><a class="header-anchor" href="#d-Retrying-Failed-Tasks">¶</a><strong>d. Retrying Failed Tasks</strong></h5>
<p>If a task fails or times out, its status can be reset to <code>PENDING</code> for retrying.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> message_queue</span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;PENDING&#x27;</span>, updated_at <span class="operator">=</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;PROCESSING&#x27;</span> <span class="keyword">AND</span> updated_at <span class="operator">&lt;</span> NOW() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">HOUR</span>;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="4-Ensuring-Reliability"><a class="header-anchor" href="#4-Ensuring-Reliability">¶</a>4. Ensuring Reliability</h4>
<ul>
<li><strong>Transactions</strong>: Wrap producer and consumer operations in transactions to ensure atomicity.</li>
<li><strong>Indexes</strong>: Add an index on <code>status</code> to optimize queries for <code>PENDING</code> tasks.</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_status <span class="keyword">ON</span> message_queue (status);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Dead Letter Queue (Optional)</strong>: Add a mechanism to move permanently failing tasks to a separate table.</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dead_letter_queue (</span><br><span class="line">    message_id <span class="type">BIGINT</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    payload TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    failure_reason TEXT,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> dead_letter_queue (message_id, payload, failure_reason)</span><br><span class="line"><span class="keyword">SELECT</span> message_id, payload, <span class="string">&#x27;Maximum retries exceeded&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> message_queue</span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;PROCESSING&#x27;</span> <span class="keyword">AND</span> updated_at <span class="operator">&lt;</span> NOW() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> message_queue <span class="keyword">WHERE</span> message_id <span class="keyword">IN</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> message_id <span class="keyword">FROM</span> dead_letter_queue</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="5-Example-Workflow"><a class="header-anchor" href="#5-Example-Workflow">¶</a>5. Example Workflow</h4>
<ol>
<li>
<p><strong>Producer adds tasks</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> message_queue (payload)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;&#123;&quot;task&quot;: &quot;send_email&quot;, &quot;email_id&quot;: 456&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Consumer fetches tasks</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">begin</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> message_id <span class="keyword">into</span> <span class="variable">@message_id</span> <span class="keyword">from</span> message_queue <span class="keyword">where</span> status <span class="operator">=</span> <span class="string">&#x27;PENDING&#x27;</span> limit <span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span> <span class="keyword">skip</span> locked;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="variable">@message_id</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="variable">@message_id</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> message_queue <span class="keyword">set</span> status<span class="operator">=</span><span class="string">&#x27;PROCESSING&#x27;</span> <span class="keyword">where</span> message_id<span class="operator">=</span><span class="variable">@message_id</span> limit <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">1</span>  Changed: <span class="number">1</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Consumer completes tasks</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> message_queue</span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;DONE&#x27;</span>, updated_at <span class="operator">=</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line"><span class="keyword">WHERE</span> message_id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>Failed tasks are retried</strong>:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> message_queue</span><br><span class="line"><span class="keyword">SET</span> status <span class="operator">=</span> <span class="string">&#x27;PENDING&#x27;</span>, updated_at <span class="operator">=</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line"><span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">&#x27;PROCESSING&#x27;</span> <span class="keyword">AND</span> updated_at <span class="operator">&lt;</span> NOW() <span class="operator">-</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">HOUR</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h4 id="6-Advantages-and-Limitations"><a class="header-anchor" href="#6-Advantages-and-Limitations">¶</a>6. Advantages and Limitations</h4>
<p><strong>Advantages:</strong></p>
<ul>
<li>Simple to implement using standard SQL.</li>
<li>No additional infrastructure required.</li>
<li>Supports concurrent producers and consumers.</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>Scalability is limited by MySQL’s performance under high load.</li>
<li>Requires careful handling of retries and dead letter queues.</li>
</ul>
<hr>
<p>By leveraging MySQL’s transactional guarantees and features like <code>FOR UPDATE SKIP LOCKED</code>, you can build a lightweight and reliable message queue suitable for many small to medium-scale applications. For more complex use cases, consider dedicated messaging systems like RabbitMQ or Kafka.</p>
</div></article></div></main><footer><div class="paginator"><a href="/mysql-tutorial/2025/01/09/Designing-a-Set-of-Tables-for-User-Login-in/" class="next">NEXT</a></div><div class="copyright"><p>© 2024 - 2025 <a href="https://mysql101.com">onlytiancai</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div></body></html>